<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ç¥çµŒè¡°å¼±ã‚²ãƒ¼ãƒ ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ä»˜ãï¼‰</title>

<style>
  body {
    font-family: sans-serif;
    text-align: center;
    background: #f5f5f5;
    margin: 0;
    padding: 20px;
  }
  h1 { margin-bottom: 5px; }
  #game-board {
    width: min(500px, 90%);
    margin: 20px auto;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
  }
  .card {
    background: #2d89ef;
    height: 110px;
    border-radius: 8px;
    cursor: pointer;
    color: white;
    font-size: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.3s;
  }
  .card.flipped, .card.matched {
    background: #fff;
    color: #333;
    cursor: default;
  }
  #restart {
    padding: 12px 24px;
    font-size: 18px;
    margin-top: 20px;
    cursor: pointer;
  }
  #ranking {
    width: min(500px, 95%);
    margin: 40px auto;
    background: #fff;
    padding: 15px;
    border-radius: 10px;
    text-align: left;
  }
  .rank-item {
    padding: 4px 0;
    border-bottom: 1px solid #ddd;
  }
</style>
</head>
<body>

<h1>ç¥çµŒè¡°å¼±ã‚²ãƒ¼ãƒ </h1>
<p id="status">ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã£ã¦ãƒšã‚¢ã‚’æ¢ãã†ï¼</p>

<div id="game-board"></div>
<button id="restart">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>

<div id="ranking">
  <h2>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆä¸Šä½10åï¼‰</h2>
  <div id="ranking-list">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
</div>

<script type="module">

/*************************************************
 * ğŸ”¥ Firebase CDN ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ­£ã—ã import
 *************************************************/
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, query, orderBy, limit, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/*************************************************
 * ğŸ”¥ ã‚ãªãŸã® Firebase Config
 *************************************************/
const firebaseConfig = {
  apiKey: "AIzaSyDPuHfKR5KM595P-mYEmjTu5QGCxXLNQwY",
  authDomain: "shinkei-cb6d0.firebaseapp.com",
  projectId: "shinkei-cb6d0",
  storageBucket: "shinkei-cb6d0.firebasestorage.app",
  messagingSenderId: "1024505518054",
  appId: "1:1024505518054:web:89195c62c36e860c256827"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/*************************************************
 * ğŸ”µ ã‚²ãƒ¼ãƒ å‡¦ç†
 *************************************************/
const board = document.getElementById("game-board");
const statusText = document.getElementById("status");
const restartBtn = document.getElementById("restart");
const rankingList = document.getElementById("ranking-list");

const icons = ["ğŸ","ğŸŒ","ğŸ‡","ğŸ’","ğŸ¥","ğŸ","ğŸ‰","ğŸ‘"];

let firstCard = null;
let secondCard = null;
let cards = [];
let lock = false;
let matchedCount = 0;
let startTime;

function initGame() {
  board.innerHTML = "";
  matchedCount = 0;
  statusText.textContent = "ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã£ã¦ãƒšã‚¢ã‚’æ¢ãã†ï¼";
  startTime = Date.now();

  cards = [...icons, ...icons]
    .sort(() => Math.random() - 0.5)
    .map((icon, i) => {
      const div = document.createElement("div");
      div.classList.add("card");
      div.dataset.icon = icon;
      div.dataset.index = i;
      div.addEventListener("click", flipCard);
      board.appendChild(div);
      return div;
    });
}

function flipCard() {
  if (lock) return;
  if (this.classList.contains("flipped")) return;

  this.textContent = this.dataset.icon;
  this.classList.add("flipped");

  if (!firstCard) {
    firstCard = this;
    return;
  }

  secondCard = this;
  lock = true;

  checkMatch();
}

function checkMatch() {
  if (firstCard.dataset.icon === secondCard.dataset.icon) {

    firstCard.classList.add("matched");
    secondCard.classList.add("matched");

    matchedCount++;

    if (matchedCount === icons.length) {
      const time = ((Date.now() - startTime) / 1000).toFixed(1);
      statusText.textContent = `ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ğŸ‰ï¼ˆ${time} ç§’ï¼‰`;

      saveScore(Number(time));
    }

    resetPair();
  } else {
    setTimeout(() => {
      firstCard.classList.remove("flipped");
      secondCard.classList.remove("flipped");
      firstCard.textContent = "";
      secondCard.textContent = "";
      resetPair();
    }, 900);
  }
}

function resetPair() {
  firstCard = null;
  secondCard = null;
  lock = false;
}

restartBtn.addEventListener("click", initGame);
initGame();

/*************************************************
 * ğŸ”¥ Firestore: ã‚¹ã‚³ã‚¢ä¿å­˜
 *************************************************/
async function saveScore(time) {
  const name = prompt("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ï¼‰", "ãªãªã—");
  if (!name) return;

  await addDoc(collection(db, "memory-ranking"), {
    name: name,
    time: time,
    createdAt: Date.now()
  });

  loadRanking();
}

/*************************************************
 * ğŸ† Firestore: ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª­ã¿è¾¼ã¿
 *************************************************/
async function loadRanking() {
  const q = query(
    collection(db, "memory-ranking"),
    orderBy("time", "asc"),
    limit(10)
  );

  const snap = await getDocs(q);
  rankingList.innerHTML = "";

  snap.forEach(doc => {
    const d = doc.data();
    const div = document.createElement("div");
    div.classList.add("rank-item");
    div.textContent = `${d.name} : ${d.time} ç§’`;
    rankingList.appendChild(div);
  });
}

loadRanking();

</script>

</body>
</html>

